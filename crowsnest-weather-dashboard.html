<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Crowsnest Pass Weather</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 30px; }
        header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        header p { font-size: 1.1em; opacity: 0.9; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.3s ease; }
        .card:hover { transform: translateY(-5px); }
        .card h2 { font-size: 1.3em; margin-bottom: 15px; color: #667eea; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .current-temp { font-size: 4em; font-weight: bold; color: #667eea; text-align: center; margin: 20px 0; }
        .current-temp .unit { font-size: 0.4em; color: #999; }
        .condition { text-align: center; font-size: 1.2em; color: #666; margin-bottom: 20px; }
        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: #666; font-weight: 500; }
        .detail-value { color: #333; font-weight: 600; }
        .todays-records { margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #fff5f5 0%, #fef5ff 100%); border-radius: 12px; border: 1px solid #eee; }
        .todays-records-title { font-size: 0.85em; font-weight: 600; color: #764ba2; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .records-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .record-item { text-align: center; padding: 10px; border-radius: 8px; }
        .record-high { background: rgba(231, 76, 60, 0.1); }
        .record-low { background: rgba(52, 152, 219, 0.1); }
        .record-label { font-size: 0.75em; color: #888; text-transform: uppercase; margin-bottom: 4px; }
        .record-temp { font-size: 1.5em; font-weight: bold; }
        .record-high .record-temp { color: #e74c3c; }
        .record-low .record-temp { color: #3498db; }
        .record-year { font-size: 0.8em; color: #999; margin-top: 2px; }
        .record-broken { display: inline-block; background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%); color: white; font-size: 0.7em; padding: 3px 8px; border-radius: 12px; margin-top: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.05); } }
        .history-section { margin-top: 20px; padding-top: 15px; border-top: 2px solid #f0f0f0; }
        .history-title { font-size: 0.9em; font-weight: 600; color: #667eea; margin-bottom: 10px; }
        .history-row { padding: 10px 0; font-size: 0.9em; border-bottom: 1px solid #f5f5f5; }
        .history-row:last-child { border-bottom: none; }
        .history-main { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .history-date { color: #444; font-weight: 500; min-width: 130px; }
        .history-temps { color: #333; font-weight: 600; }
        .history-records { font-size: 0.8em; color: #777; margin-top: 6px; width: 100%; }
        .history-records .rec-high { color: #c0392b; font-weight: 500; }
        .history-records .rec-low { color: #2980b9; font-weight: 500; }
        .record-marker { display: inline-block; font-size: 0.65em; padding: 2px 6px; border-radius: 8px; margin-left: 4px; font-weight: bold; }
        .record-marker.high { background: #e74c3c; color: white; }
        .record-marker.low { background: #3498db; color: white; }
        .forecast-card { background: linear-gradient(135deg, #74ebd5 0%, #9face6 100%); }
        .forecast-card h2 { color: #2d3748; }
        .forecast-list { margin-top: 15px; }
        .forecast-item { padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .forecast-item:last-child { border-bottom: none; }
        .forecast-item.today { background: rgba(102, 126, 234, 0.15); margin: 0 -10px; padding: 10px; border-radius: 8px; }
        .forecast-main { display: flex; justify-content: space-between; align-items: center; }
        .forecast-day { font-weight: 500; color: #333; min-width: 80px; }
        .forecast-condition { flex-grow: 1; text-align: center; color: #555; font-size: 0.9em; padding: 0 10px; }
        .forecast-temps { text-align: right; min-width: 80px; }
        .forecast-high { font-weight: bold; color: #e74c3c; }
        .forecast-low { color: #3498db; }
        .forecast-records { font-size: 0.78em; color: #444; margin-top: 6px; }
        .forecast-records .rec-high { color: #c0392b; font-weight: 500; }
        .forecast-records .rec-low { color: #2980b9; font-weight: 500; }
        .wind-direction { text-align: center; margin: 20px 0; }
        .wind-arrow { font-size: 3em; display: inline-block; transition: transform 0.3s ease; }
        .wind-speed { font-size: 2em; font-weight: bold; color: #764ba2; margin-top: 10px; text-align: center; }
        .gust-info { text-align: center; margin-top: 10px; padding: 10px; background: rgba(118, 75, 162, 0.1); border-radius: 8px; font-size: 0.95em; color: #666; }
        .gust-speed { font-weight: bold; color: #764ba2; }
        .daily-max-gust { text-align: center; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); border-radius: 8px; color: white; }
        .daily-max-gust .label { font-size: 0.85em; opacity: 0.9; }
        .daily-max-gust .value { font-size: 1.4em; font-weight: bold; margin-top: 5px; }
        .historical-compare { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .pressure-card { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
        .pressure-value { font-size: 2.5em; font-weight: bold; text-align: center; color: #5e35b1; margin: 15px 0; }
        .trend { text-align: center; font-size: 1.1em; color: #666; }
        .trend-up { color: #e74c3c; }
        .trend-down { color: #3498db; }
        .pressure-chart-container { margin-top: 20px; background: rgba(255,255,255,0.4); border-radius: 10px; padding: 15px; }
        .pressure-chart-title { font-size: 0.85em; font-weight: 600; color: #5e35b1; margin-bottom: 10px; text-align: center; }
        .pressure-chart-note { font-size: 0.75em; color: #777; text-align: center; margin-top: 8px; }
        .loading { text-align: center; padding: 40px; color: #999; font-style: italic; }
        .error { background: #fee; color: #c33; padding: 15px; border-radius: 8px; margin: 10px 0; font-size: 0.9em; }
        .timestamp { text-align: center; color: white; opacity: 0.8; margin-top: 20px; font-size: 0.9em; }
        .source-link { font-size: 0.7em; font-weight: normal; color: #999; }
        .source-link a { color: #667eea; text-decoration: none; }
        .source-link a:hover { text-decoration: underline; }
        .avg-high-badge { font-size: 0.65em; font-weight: normal; color: #888; margin-left: 6px; }
        .avg-high-badge .temp { font-weight: 600; color: #e74c3c; }
        @media (max-width: 768px) {
            header h1 { font-size: 1.8em; }
            .current-temp { font-size: 3em; }
            .dashboard { grid-template-columns: 1fr; }
            .records-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèîÔ∏è Crowsnest Pass Weather</h1>
            <p>Alberta's Windiest Mountain Pass - Live from Environment Canada</p>
        </header>
        <div class="dashboard">
            <div class="card" id="current-card"><h2>Current Conditions</h2><div class="loading">Loading...</div></div>
            <div class="card forecast-card" id="forecast-card"><h2>7-Day Forecast</h2><div class="loading">Loading...</div></div>
            <div class="card historical-compare" id="historical-card"><h2>Climate Normals</h2><div class="loading">Loading...</div></div>
            <div class="card" id="wind-card"><h2>Wind Conditions</h2><div class="loading">Loading...</div></div>
            <div class="card pressure-card" id="pressure-card"><h2>Air Pressure</h2><div class="loading">Loading...</div></div>
        </div>
        <div class="timestamp" id="timestamp"></div>
    </div>

    <script>
        // Version 2.5 - Multiple CORS proxy fallbacks for forecast reliability
        const CONFIG = {
            WEATHER_JSON_URL: './data/current_conditions.json',
            HISTORY_JSON_URL: './data/temperature_history.json',
            RECORDS_JSON_URL: './data/daily_records.json',
            PRESSURE_HISTORY_URL: './data/pressure_history.json',
            RSS_URL: 'https://weather.gc.ca/rss/weather/49.631_-114.693_e.xml',
            EC_PAGE_URL: 'https://weather.gc.ca/en/location/index.html?coords=49.631,-114.693',
            GITHUB_RAW_URL: 'https://raw.githubusercontent.com/maxmaudie-design/crowsnest-weather/main/data/',
            CORS_PROXIES: [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?url=',
                'https://api.codetabs.com/v1/proxy?quest='
            ]
        };

        let currentData = null, historyData = null, dailyStats = null, recordsData = null, forecastData = null, pressureHistoryData = null;

        const formatTemp = (t) => t == null ? '--' : t.toFixed(1);
        const formatTempInt = (t) => t == null ? '--' : Math.round(t);
        const getDateKey = (d) => `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        
        function parseLocalDate(s) {
            const [y, m, d] = s.split('-').map(Number);
            return new Date(y, m - 1, d, 12, 0, 0);
        }

        function isYesterday(date) {
            const today = new Date();
            const yesterday = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 1);
            return date.getFullYear() === yesterday.getFullYear() && 
                   date.getMonth() === yesterday.getMonth() && 
                   date.getDate() === yesterday.getDate();
        }

        function formatUTCtoLocal(utcTimeStr) {
            if (!utcTimeStr) return '';
            const match = utcTimeStr.match(/(\d{1,2}):(\d{2})\s*UTC/i);
            if (!match) return utcTimeStr;
            const utcH = parseInt(match[1]), utcM = parseInt(match[2]);
            const now = new Date();
            const utcDate = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate(), utcH, utcM));
            return utcDate.toLocaleTimeString('en-US', { 
                hour: 'numeric', minute: '2-digit', 
                timeZone: 'America/Edmonton'
            });
        }

        function getWeatherIcon(c) {
            if (!c) return 'üå°Ô∏è';
            const l = c.toLowerCase();
            if (l.includes('sunny') || l.includes('clear')) return '‚òÄÔ∏è';
            if (l.includes('partly') && l.includes('cloud')) return '‚õÖ';
            if (l.includes('cloudy') || l.includes('overcast')) return '‚òÅÔ∏è';
            if (l.includes('rain') && l.includes('snow')) return 'üå®Ô∏è';
            if (l.includes('rain') || l.includes('shower')) return 'üåßÔ∏è';
            if (l.includes('snow') || l.includes('flurr')) return '‚ùÑÔ∏è';
            if (l.includes('thunder') || l.includes('storm')) return '‚õàÔ∏è';
            if (l.includes('fog') || l.includes('mist')) return 'üå´Ô∏è';
            if (l.includes('wind')) return 'üí®';
            if (l.includes('mix')) return 'üå®Ô∏è';
            return 'üå§Ô∏è';
        }

        async function fetchWithCorsProxies(url) {
            for (const proxy of CONFIG.CORS_PROXIES) {
                try {
                    const proxyUrl = proxy + encodeURIComponent(url);
                    console.log('Trying proxy:', proxy.split('//')[1]?.split('/')[0]);
                    const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(8000) });
                    if (response.ok) {
                        const text = await response.text();
                        if (text.includes('<feed') || text.includes('<entry')) {
                            console.log('Proxy succeeded:', proxy.split('//')[1]?.split('/')[0]);
                            return text;
                        }
                    }
                } catch (e) {
                    console.warn('Proxy failed:', proxy.split('//')[1]?.split('/')[0], e.message);
                }
            }
            // Last resort: direct fetch (will fail on GitHub Pages due to CORS, but works locally)
            try {
                const response = await fetch(url, { signal: AbortSignal.timeout(5000) });
                if (response.ok) return await response.text();
            } catch (e) {
                console.warn('Direct fetch failed:', e.message);
            }
            return null;
        }

        async function fetchForecast() {
            try {
                const xmlText = await fetchWithCorsProxies(CONFIG.RSS_URL);
                if (!xmlText) throw new Error('All proxies failed');
                const xmlDoc = new DOMParser().parseFromString(xmlText, 'text/xml');
                const forecasts = [];
                xmlDoc.querySelectorAll('entry').forEach(entry => {
                    const title = entry.querySelector('title')?.textContent || '';
                    const summary = entry.querySelector('summary')?.textContent || '';
                    if (title.match(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday|Tonight|Today)/i)) {
                        const highMatch = summary.match(/High\s*(minus\s*)?(\d+)/i);
                        const lowMatch = summary.match(/Low\s*(minus\s*)?(\d+)/i);
                        let high = highMatch ? parseInt(highMatch[2]) * (highMatch[1] ? -1 : 1) : null;
                        let low = lowMatch ? parseInt(lowMatch[2]) * (lowMatch[1] ? -1 : 1) : null;
                        const condMatch = title.match(/:\s*(.+)/);
                        const dayMatch = title.match(/^(\w+)/);
                        forecasts.push({
                            day: dayMatch?.[1] || '',
                            condition: condMatch?.[1]?.trim() || '',
                            high, low,
                            isNight: title.toLowerCase().includes('night') || title.toLowerCase().includes('tonight')
                        });
                    }
                });
                forecastData = combineDayNight(forecasts);
                console.log('Forecast loaded:', forecastData?.length, 'days');
            } catch (e) {
                console.error('Forecast error:', e);
                forecastData = null;
            }
        }

        function combineDayNight(forecasts) {
            const combined = [];
            let i = 0, offset = 0;
            while (i < forecasts.length && combined.length < 7) {
                const cur = forecasts[i], next = forecasts[i+1];
                if (cur.isNight) {
                    combined.push({ day: cur.day === 'Tonight' ? 'Tonight' : cur.day, condition: cur.condition, high: null, low: cur.low || cur.high, icon: getWeatherIcon(cur.condition), offset });
                    i++; offset++;
                } else if (next?.isNight) {
                    combined.push({ day: cur.day, condition: cur.condition, high: cur.high, low: next.low || next.high, icon: getWeatherIcon(cur.condition), offset });
                    i += 2; offset++;
                } else {
                    combined.push({ day: cur.day, condition: cur.condition, high: cur.high, low: cur.low, icon: getWeatherIcon(cur.condition), offset });
                    i++; offset++;
                }
            }
            return combined;
        }

        function displayForecast() {
            if (!forecastData?.length) {
                document.getElementById('forecast-card').innerHTML = `<h2>7-Day Forecast</h2><div class="error">Unable to load. <a href="${CONFIG.EC_PAGE_URL}" target="_blank">View at EC</a></div>`;
                return;
            }
            const forecastHighs = forecastData.filter(d => d.high != null).map(d => d.high);
            const avgForecastHigh = forecastHighs.length > 0 ? (forecastHighs.reduce((a,b) => a+b, 0) / forecastHighs.length) : null;
            const avgBadge = avgForecastHigh != null ? `<span class="avg-high-badge">Avg High: <span class="temp">${Math.round(avgForecastHigh)}¬∞</span></span>` : '';
            const today = new Date();
            const html = forecastData.map((d, i) => {
                const fDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + d.offset);
                const key = getDateKey(fDate);
                const rec = recordsData?.records_by_day?.[key];
                let recHtml = '';
                if (rec) {
                    recHtml = `<div class="forecast-records">üìä Record High: <span class="rec-high">${formatTempInt(rec.record_high)}¬∞ (${rec.record_high_year})</span> ¬∑ Record Low: <span class="rec-low">${formatTempInt(rec.record_low)}¬∞ (${rec.record_low_year})</span></div>`;
                }
                return `<div class="forecast-item${i===0?' today':''}">
                    <div class="forecast-main">
                        <span class="forecast-day">${d.day}</span>
                        <span class="forecast-condition">${d.icon} ${d.condition}</span>
                        <span class="forecast-temps">${d.high!=null?`<span class="forecast-high">${d.high}¬∞</span>`:''}${d.low!=null?`<span class="forecast-low"> / ${d.low}¬∞</span>`:''}</span>
                    </div>
                    ${recHtml}
                </div>`;
            }).join('');
            document.getElementById('forecast-card').innerHTML = `
                <h2>7-Day Forecast ${avgBadge}</h2>
                <div class="forecast-list">${html}</div>
                <div style="margin-top:15px;text-align:center;font-size:0.8em;color:#555;"><a href="${CONFIG.EC_PAGE_URL}" target="_blank" style="color:#667eea;">Full forecast ‚Üí</a></div>
            `;
        }

        async function fetchRecords() {
            try {
                const url = CONFIG.RECORDS_JSON_URL + '?v=' + Date.now();
                let r = await fetch(url);
                if (!r.ok) r = await fetch(CONFIG.GITHUB_RAW_URL + 'daily_records.json?v=' + Date.now());
                if (r.ok) recordsData = await r.json();
            } catch (e) { console.error('Records fetch error:', e); }
        }

        async function fetchHistory() {
            try {
                const url = CONFIG.HISTORY_JSON_URL + '?v=' + Date.now();
                let r = await fetch(url);
                if (!r.ok) r = await fetch(CONFIG.GITHUB_RAW_URL + 'temperature_history.json?v=' + Date.now());
                if (r.ok) historyData = await r.json();
            } catch (e) { console.log('History unavailable:', e); }
        }

        async function fetchPressureHistory() {
            try {
                const url = CONFIG.PRESSURE_HISTORY_URL + '?v=' + Date.now();
                let r = await fetch(url);
                if (!r.ok) r = await fetch(CONFIG.GITHUB_RAW_URL + 'pressure_history.json?v=' + Date.now());
                if (r.ok) pressureHistoryData = await r.json();
            } catch (e) { console.log('Pressure history unavailable:', e); }
        }

        async function fetchAllData() {
            try {
                await Promise.all([
                    (async () => {
                        const url = CONFIG.WEATHER_JSON_URL + '?v=' + Date.now();
                        let r = await fetch(url);
                        if (!r.ok) r = await fetch(CONFIG.GITHUB_RAW_URL + 'current_conditions.json?v=' + Date.now());
                        if (!r.ok) throw new Error('HTTP ' + r.status);
                        const raw = await r.json();
                        dailyStats = raw.daily_stats;
                        currentData = {
                            temperature: raw.conditions?.temperature,
                            condition: raw.conditions?.condition,
                            pressure: raw.conditions?.pressure_kpa,
                            tendency: raw.conditions?.pressure_tendency,
                            windSpeed: raw.conditions?.wind_speed_kmh,
                            windGust: raw.conditions?.wind_gust_kmh,
                            dailyMaxGust: raw.conditions?.daily_max_gust_kmh || raw.daily_stats?.max_gust_kmh,
                            windDirection: raw.conditions?.wind_direction,
                            humidity: raw.conditions?.humidity_percent,
                            dewpoint: raw.conditions?.dewpoint
                        };
                    })(),
                    fetchHistory(),
                    fetchRecords(),
                    fetchForecast(),
                    fetchPressureHistory()
                ]);
                displayCurrent();
                displayForecast();
                displayNormals();
                displayWind();
                displayPressure();
            } catch (e) {
                console.error('Error fetching data:', e);
                document.getElementById('current-card').innerHTML = `<h2>Current Conditions</h2><div class="error">Unable to load. <a href="${CONFIG.EC_PAGE_URL}" target="_blank">View at EC</a></div>`;
            }
        }

        function displayCurrent() {
            const today = new Date();
            const todayKey = getDateKey(today);
            let todayRecHtml = '';
            const todayRec = recordsData?.records_by_day?.[todayKey];
            if (todayRec) {
                let brokenHtml = '';
                if (dailyStats?.high_temp != null && todayRec.record_high != null && dailyStats.high_temp > todayRec.record_high) {
                    brokenHtml = `<span class="record-broken">üî• NEW RECORD! ${formatTemp(dailyStats.high_temp)}¬∞C</span>`;
                }
                todayRecHtml = `
                    <div class="todays-records">
                        <div class="todays-records-title">üìä Today's Records (${today.toLocaleDateString('en-US',{month:'short',day:'numeric'})})</div>
                        <div class="records-grid">
                            <div class="record-item record-high">
                                <div class="record-label">Record High</div>
                                <div class="record-temp">${todayRec.record_high!=null?formatTemp(todayRec.record_high)+'¬∞':'--'}</div>
                                <div class="record-year">${todayRec.record_high_year||'--'}</div>
                                ${brokenHtml}
                            </div>
                            <div class="record-item record-low">
                                <div class="record-label">Record Low</div>
                                <div class="record-temp">${todayRec.record_low!=null?formatTemp(todayRec.record_low)+'¬∞':'--'}</div>
                                <div class="record-year">${todayRec.record_low_year||'--'}</div>
                            </div>
                        </div>
                    </div>`;
            }
            let todayHighHtml = '';
            if (dailyStats?.high_temp != null) {
                const timeStr = formatUTCtoLocal(dailyStats.high_temp_time);
                todayHighHtml = `<div class="detail-row"><span class="detail-label">Today's High</span><span class="detail-value" style="color:#e74c3c">${formatTemp(dailyStats.high_temp)}¬∞C${timeStr ? ` <span style="font-size:0.8em;color:#999;font-weight:normal">at ${timeStr}</span>` : ''}</span></div>`;
            }
            let todayLowHtml = '';
            if (dailyStats?.low_temp != null) {
                const timeStr = formatUTCtoLocal(dailyStats.low_temp_time);
                todayLowHtml = `<div class="detail-row"><span class="detail-label">Today's Low</span><span class="detail-value" style="color:#3498db">${formatTemp(dailyStats.low_temp)}¬∞C${timeStr ? ` <span style="font-size:0.8em;color:#999;font-weight:normal">at ${timeStr}</span>` : ''}</span></div>`;
            }
            let histHtml = '';
            if (historyData?.daily_records?.length) {
                const highs = historyData.daily_records.filter(r => r.high != null).map(r => r.high);
                const avgHigh = highs.length > 0 ? (highs.reduce((a,b) => a+b, 0) / highs.length) : null;
                const avgBadge = avgHigh != null ? `<span class="avg-high-badge">Avg High: <span class="temp">${Math.round(avgHigh)}¬∞</span></span>` : '';
                histHtml = `<div class="history-section"><div class="history-title">Past 7 Days ${avgBadge}</div>
                    ${historyData.daily_records.map(rec => {
                        const date = parseLocalDate(rec.date);
                        const dayLabel = isYesterday(date) 
                            ? 'Yesterday' 
                            : date.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
                        const key = getDateKey(date);
                        const dayRec = recordsData?.records_by_day?.[key];
                        let markers = '';
                        if (dayRec) {
                            if (rec.high != null && dayRec.record_high != null && rec.high >= dayRec.record_high) markers += '<span class="record-marker high">REC HIGH</span>';
                            if (rec.low != null && dayRec.record_low != null && rec.low <= dayRec.record_low) markers += '<span class="record-marker low">REC LOW</span>';
                        }
                        let recLine = '';
                        if (dayRec) {
                            recLine = `<div class="history-records">üìä Record High: <span class="rec-high">${formatTemp(dayRec.record_high)}¬∞ (${dayRec.record_high_year})</span> ¬∑ Record Low: <span class="rec-low">${formatTemp(dayRec.record_low)}¬∞ (${dayRec.record_low_year})</span></div>`;
                        }
                        return `<div class="history-row">
                            <div class="history-main">
                                <span class="history-date">${dayLabel}</span>
                                <span class="history-temps">${formatTemp(rec.high)}¬∞ / ${formatTemp(rec.low)}¬∞${markers}</span>
                            </div>
                            ${recLine}
                        </div>`;
                    }).join('')}
                </div>`;
            }
            document.getElementById('current-card').innerHTML = `
                <h2>Current Conditions <span class="source-link">¬∑ <a href="${CONFIG.EC_PAGE_URL}" target="_blank">Environment Canada</a></span></h2>
                <div class="current-temp">${formatTemp(currentData.temperature)}<span class="unit">¬∞C</span></div>
                <div class="condition">${currentData.condition||'Not Available'}</div>
                ${todayHighHtml}
                ${todayLowHtml}
                <div class="detail-row"><span class="detail-label">Humidity</span><span class="detail-value">${currentData.humidity||'--'}%</span></div>
                <div class="detail-row"><span class="detail-label">Dewpoint</span><span class="detail-value">${formatTemp(currentData.dewpoint)}¬∞C</span></div>
                ${todayRecHtml}
                ${histHtml}
            `;
        }

        function displayWind() {
            const arrows = {'N':'‚Üì','NNE':'‚Üì','NE':'‚Üô','ENE':'‚Üô','E':'‚Üê','ESE':'‚Üê','SE':'‚Üñ','SSE':'‚Üñ','S':'‚Üë','SSW':'‚Üë','SW':'‚Üó','WSW':'‚Üó','W':'‚Üí','WNW':'‚Üí','NW':'‚Üò','NNW':'‚Üò'};
            const angles = {'N':180,'NNE':202.5,'NE':225,'ENE':247.5,'E':270,'ESE':292.5,'SE':315,'SSE':337.5,'S':0,'SSW':22.5,'SW':45,'WSW':67.5,'W':90,'WNW':112.5,'NW':135,'NNW':157.5};
            const dir = currentData.windDirection?.toUpperCase() || '';
            const arrow = arrows[dir] || '‚óÜ';
            const rot = angles[dir] || 0;
            let gustHtml = currentData.windGust > 0 ? `<div class="gust-info">Gusts: <span class="gust-speed">${currentData.windGust} km/h</span> (${(currentData.windGust*0.621371).toFixed(1)} mph)</div>` : '';
            let maxGustHtml = currentData.dailyMaxGust > 0 ? `<div class="daily-max-gust"><div class="label">üå™Ô∏è Today's Max Gust</div><div class="value">${currentData.dailyMaxGust} km/h (${(currentData.dailyMaxGust*0.621371).toFixed(1)} mph)</div></div>` : '';
            document.getElementById('wind-card').innerHTML = `
                <h2>Wind Conditions</h2>
                <div class="wind-direction"><div class="wind-arrow" style="transform:rotate(${rot}deg)">${arrow}</div><div style="margin-top:10px;color:#666;font-size:1.2em">${currentData.windDirection||'Variable'}</div></div>
                <div class="wind-speed">${currentData.windSpeed||'0'} km/h</div>
                <div style="text-align:center;margin-top:10px;color:#666;font-size:0.9em">${currentData.windSpeed?`${(currentData.windSpeed*0.621371).toFixed(1)} mph`:''}</div>
                ${gustHtml}${maxGustHtml}
            `;
        }

        function displayPressure() {
            let trend = '', cls = '';
            if (currentData.tendency?.includes('ris')) { trend = '‚Üó Rising'; cls = 'trend-up'; }
            else if (currentData.tendency?.includes('fall')) { trend = '‚Üò Falling'; cls = 'trend-down'; }
            else if (currentData.tendency) { trend = '‚Üí Steady'; }
            let chartHtml = '';
            const readings = pressureHistoryData?.hourly_readings;
            if (readings && readings.length >= 2) {
                chartHtml = `
                    <div class="pressure-chart-container">
                        <div class="pressure-chart-title">72-Hour Pressure History</div>
                        <canvas id="pressure-chart" width="400" height="160" style="width:100%;height:160px;"></canvas>
                        <div class="pressure-chart-note">${readings.length} reading${readings.length!==1?'s':''} ¬∑ Updates hourly</div>
                    </div>`;
            } else {
                chartHtml = `
                    <div class="pressure-chart-container">
                        <div class="pressure-chart-title">72-Hour Pressure History</div>
                        <div style="text-align:center;padding:20px;color:#888;font-size:0.85em;">Building history... (${readings?.length || 0} reading${readings?.length!==1?'s':''} so far)</div>
                    </div>`;
            }
            document.getElementById('pressure-card').innerHTML = `
                <h2>Air Pressure</h2>
                <div class="pressure-value">${currentData.pressure!=null?currentData.pressure.toFixed(1):'--'} <span style="font-size:0.5em;color:#999">kPa</span></div>
                ${trend?`<div class="trend ${cls}">${trend}</div>`:''}
                <div style="text-align:center;margin-top:15px;color:#666;font-size:0.9em">${currentData.pressure?`${(currentData.pressure*10).toFixed(1)} mb | ${(currentData.pressure*0.2953).toFixed(2)} inHg`:''}</div>
                ${chartHtml}
                <div style="margin-top:20px;padding:12px;background:rgba(255,255,255,0.3);border-radius:8px;font-size:0.85em;color:#555"><strong>Wind Prediction:</strong> Falling pressure often means wind & storms ahead.</div>
            `;
            if (readings && readings.length >= 2) {
                requestAnimationFrame(() => drawPressureChart(readings));
            }
        }

        function drawPressureChart(readings) {
            const canvas = document.getElementById('pressure-chart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const W = rect.width, H = rect.height;
            const padding = { top: 20, right: 15, bottom: 30, left: 42 };
            const chartW = W - padding.left - padding.right;
            const chartH = H - padding.top - padding.bottom;
            const values = readings.map(r => r.kpa);
            const minP = Math.floor(Math.min(...values) * 10) / 10 - 0.1;
            const maxP = Math.ceil(Math.max(...values) * 10) / 10 + 0.1;
            const rangeP = maxP - minP || 1;
            const toX = (i) => padding.left + (i / (readings.length - 1)) * chartW;
            const toY = (v) => padding.top + chartH - ((v - minP) / rangeP) * chartH;
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.fillRect(padding.left, padding.top, chartW, chartH);
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 0.5;
            const gridSteps = 4;
            for (let i = 0; i <= gridSteps; i++) {
                const val = minP + (rangeP * i / gridSteps);
                const y = toY(val);
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(W - padding.right, y);
                ctx.stroke();
                ctx.fillStyle = '#888';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(val.toFixed(1), padding.left - 4, y + 3);
            }
            ctx.fillStyle = '#888';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            const labelCount = Math.min(6, readings.length);
            for (let i = 0; i < labelCount; i++) {
                const idx = Math.round(i * (readings.length - 1) / (labelCount - 1));
                const r = readings[idx];
                const d = new Date(r.hour || '');
                const label = d.toLocaleTimeString('en-US', { hour: 'numeric', timeZone: 'America/Edmonton' });
                const dayLabel = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'America/Edmonton' });
                ctx.fillText(label, toX(idx), H - padding.bottom + 12);
                if (i === 0 || i === labelCount - 1) {
                    ctx.fillText(dayLabel, toX(idx), H - padding.bottom + 22);
                }
            }
            ctx.strokeStyle = '#5e35b1';
            ctx.lineWidth = 2;
            ctx.lineJoin = 'round';
            ctx.beginPath();
            readings.forEach((r, i) => {
                const x = toX(i), y = toY(r.kpa);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.stroke();
            ctx.lineTo(toX(readings.length - 1), padding.top + chartH);
            ctx.lineTo(toX(0), padding.top + chartH);
            ctx.closePath();
            ctx.fillStyle = 'rgba(94, 53, 177, 0.1)';
            ctx.fill();
            [0, readings.length - 1].forEach(i => {
                ctx.beginPath();
                ctx.arc(toX(i), toY(readings[i].kpa), 3, 0, Math.PI * 2);
                ctx.fillStyle = '#5e35b1';
                ctx.fill();
            });
            ctx.save();
            ctx.translate(10, padding.top + chartH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillStyle = '#888';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('kPa', 0, 0);
            ctx.restore();
        }

        function displayNormals() {
            const month = new Date().toLocaleDateString('en-US',{month:'long'});
            const normals = {'January':{h:-2,l:-14},'February':{h:0,l:-12},'March':{h:4,l:-8},'April':{h:10,l:-3},'May':{h:15,l:2},'June':{h:19,l:6},'July':{h:23,l:8},'August':{h:22,l:7},'September':{h:17,l:3},'October':{h:11,l:-2},'November':{h:2,l:-9},'December':{h:-2,l:-13}};
            const n = normals[month] || {h:0,l:0};
            const cmp = currentData?.temperature != null ? `<div class="detail-row"><span class="detail-label">Current vs Normal</span><span class="detail-value" style="color:${currentData.temperature>n.h?'#e74c3c':currentData.temperature<n.l?'#3498db':'#27ae60'}">${currentData.temperature>n.h?'‚ñ≤ Above':currentData.temperature<n.l?'‚ñº Below':'‚óè Normal'}</span></div>` : '';
            document.getElementById('historical-card').innerHTML = `
                <h2>Climate Normals</h2>
                <div class="detail-row"><span class="detail-label">Month</span><span class="detail-value">${month}</span></div>
                <div class="detail-row"><span class="detail-label">Normal High</span><span class="detail-value">${n.h}¬∞C</span></div>
                <div class="detail-row"><span class="detail-label">Normal Low</span><span class="detail-value">${n.l}¬∞C</span></div>
                ${cmp}
                <div style="margin-top:20px;padding:15px;background:rgba(255,255,255,0.5);border-radius:8px;font-size:0.9em;color:#666"><strong>Note:</strong> Normals from 1981-2010 data. Records from 113+ years (1893-2026).</div>
            `;
        }

        function updateTimestamp() {
            document.getElementById('timestamp').textContent = `Last updated: ${new Date().toLocaleString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',timeZoneName:'short'})} ¬∑ v2.5`;
        }

        async function init() {
            console.log('Weather dashboard v2.5 starting...');
            await fetchAllData();
            updateTimestamp();
            setInterval(async () => { await fetchAllData(); updateTimestamp(); }, 10*60*1000);
        }
        init();
    </script>
</body>
</html>
