<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowsnest Pass Weather</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #667eea;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .current-temp {
            font-size: 4em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }

        .current-temp .unit {
            font-size: 0.4em;
            color: #999;
        }

        .condition {
            text-align: center;
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #666;
            font-weight: 500;
        }

        .detail-value {
            color: #333;
            font-weight: 600;
        }

        /* Today's Records Section */
        .todays-records {
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #fff5f5 0%, #fef5ff 100%);
            border-radius: 12px;
            border: 1px solid #eee;
        }

        .todays-records-title {
            font-size: 0.85em;
            font-weight: 600;
            color: #764ba2;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .records-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .record-item {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
        }

        .record-high {
            background: rgba(231, 76, 60, 0.1);
        }

        .record-low {
            background: rgba(52, 152, 219, 0.1);
        }

        .record-label {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .record-temp {
            font-size: 1.5em;
            font-weight: bold;
        }

        .record-high .record-temp {
            color: #e74c3c;
        }

        .record-low .record-temp {
            color: #3498db;
        }

        .record-year {
            font-size: 0.8em;
            color: #999;
            margin-top: 2px;
        }

        .record-broken {
            display: inline-block;
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
            color: white;
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 12px;
            margin-top: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        /* History Section */
        .history-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }

        .history-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        .history-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 0.9em;
            border-bottom: 1px solid #f5f5f5;
        }

        .history-row:last-child {
            border-bottom: none;
        }

        .history-date {
            color: #666;
            min-width: 100px;
        }

        .history-temps {
            color: #333;
            font-weight: 500;
            flex-grow: 1;
            text-align: center;
        }

        .history-records {
            font-size: 0.8em;
            color: #aaa;
            text-align: right;
            min-width: 140px;
        }

        .record-marker {
            display: inline-block;
            font-size: 0.7em;
            padding: 1px 5px;
            border-radius: 8px;
            margin-left: 4px;
            font-weight: bold;
        }

        .record-marker.high {
            background: #e74c3c;
            color: white;
        }

        .record-marker.low {
            background: #3498db;
            color: white;
        }

        /* 7-Day Forecast Card */
        .forecast-card {
            background: linear-gradient(135deg, #74ebd5 0%, #9face6 100%);
        }

        .forecast-card h2 {
            color: #2d3748;
        }

        .forecast-list {
            margin-top: 15px;
        }

        .forecast-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .forecast-list-item:last-child {
            border-bottom: none;
        }

        .forecast-list-item.today {
            background: rgba(102, 126, 234, 0.15);
            margin: 0 -10px;
            padding: 10px;
            border-radius: 8px;
        }

        .forecast-list-day {
            font-weight: 500;
            color: #333;
            min-width: 80px;
        }

        .forecast-list-condition {
            flex-grow: 1;
            text-align: center;
            color: #555;
            font-size: 0.9em;
            padding: 0 10px;
        }

        .forecast-list-temps {
            text-align: right;
            min-width: 80px;
        }

        .forecast-high {
            font-weight: bold;
            color: #e74c3c;
        }

        .forecast-low {
            color: #3498db;
        }

        .forecast-records {
            width: 100%;
            font-size: 0.75em;
            color: #666;
            margin-top: 4px;
            padding-left: 80px;
        }

        .forecast-records .rec-high {
            color: #c0392b;
        }

        .forecast-records .rec-low {
            color: #2980b9;
        }

        .wind-direction {
            text-align: center;
            margin: 20px 0;
        }

        .wind-arrow {
            font-size: 3em;
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .wind-speed {
            font-size: 2em;
            font-weight: bold;
            color: #764ba2;
            margin-top: 10px;
        }

        .gust-info {
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            background: rgba(118, 75, 162, 0.1);
            border-radius: 8px;
            font-size: 0.95em;
            color: #666;
        }

        .gust-speed {
            font-weight: bold;
            color: #764ba2;
        }

        .daily-max-gust {
            text-align: center;
            margin-top: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border-radius: 8px;
            color: white;
        }

        .daily-max-gust .label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .daily-max-gust .value {
            font-size: 1.4em;
            font-weight: bold;
            margin-top: 5px;
        }

        .historical-compare {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .pressure-card {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }

        .pressure-value {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            color: #5e35b1;
            margin: 15px 0;
        }

        .trend {
            text-align: center;
            font-size: 1.1em;
            color: #666;
        }

        .trend-up {
            color: #e74c3c;
        }

        .trend-down {
            color: #3498db;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .timestamp {
            text-align: center;
            color: white;
            opacity: 0.8;
            margin-top: 20px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }
            
            .current-temp {
                font-size: 3em;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }

            .history-row {
                flex-direction: column;
                gap: 4px;
                padding: 10px 0;
            }

            .history-date, .history-temps, .history-records {
                text-align: left;
                width: 100%;
            }

            .history-records {
                font-size: 0.75em;
            }

            .records-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .forecast-list-item {
                flex-wrap: wrap;
            }

            .forecast-list-condition {
                order: 3;
                width: 100%;
                text-align: left;
                padding: 5px 0 0 0;
                font-size: 0.85em;
            }

            .forecast-records {
                padding-left: 0;
                order: 4;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèîÔ∏è Crowsnest Pass Weather</h1>
            <p>Alberta's Windiest Mountain Pass - Live from Environment Canada</p>
        </header>

        <div class="dashboard">
            <!-- Current Conditions Card -->
            <div class="card" id="current-card">
                <h2>Current Conditions</h2>
                <div class="loading">Loading current data...</div>
            </div>

            <!-- 7-Day Forecast Card -->
            <div class="card forecast-card" id="forecast-card">
                <h2>7-Day Forecast</h2>
                <div class="loading">Loading forecast...</div>
            </div>

            <!-- Climate Normals Card -->
            <div class="card historical-compare" id="historical-card">
                <h2>Climate Normals</h2>
                <div class="loading">Loading climate data...</div>
            </div>

            <!-- Wind Card -->
            <div class="card" id="wind-card">
                <h2>Wind Conditions</h2>
                <div class="loading">Loading wind data...</div>
            </div>

            <!-- Air Pressure Card -->
            <div class="card pressure-card" id="pressure-card">
                <h2>Air Pressure</h2>
                <div class="loading">Loading pressure data...</div>
            </div>
        </div>

        <div class="timestamp" id="timestamp"></div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            WEATHER_JSON_URL: './data/current_conditions.json',
            HISTORY_JSON_URL: './data/temperature_history.json',
            RECORDS_JSON_URL: './data/daily_records.json',
            RSS_URL: 'https://weather.gc.ca/rss/weather/49.631_-114.693_e.xml',
            GITHUB_RAW_URL: 'https://raw.githubusercontent.com/maxmaudie-design/crowsnest-weather/main/data/',
            CORS_PROXY: 'https://api.allorigins.win/raw?url=',
            COORDS: { lat: 49.631, lon: -114.693 }
        };

        let currentData = null;
        let historyData = null;
        let dailyStats = null;
        let recordsData = null;
        let forecastData = null;

        // Format temperature
        function formatTemp(temp) {
            if (temp === undefined || temp === null) return '--';
            return temp.toFixed(1);
        }

        // Format temperature as integer (for forecast display)
        function formatTempInt(temp) {
            if (temp === undefined || temp === null) return '--';
            return Math.round(temp);
        }

        // Get date key for records lookup (MM-DD format)
        function getDateKey(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}-${day}`;
        }

        // Get weather icon based on condition
        function getWeatherIcon(condition) {
            if (!condition) return 'üå°Ô∏è';
            const cond = condition.toLowerCase();
            
            if (cond.includes('sunny') || cond.includes('clear')) return '‚òÄÔ∏è';
            if (cond.includes('partly') && cond.includes('cloud')) return '‚õÖ';
            if (cond.includes('cloudy') || cond.includes('overcast')) return '‚òÅÔ∏è';
            if (cond.includes('rain') && cond.includes('snow')) return 'üå®Ô∏è';
            if (cond.includes('rain') || cond.includes('shower')) return 'üåßÔ∏è';
            if (cond.includes('snow') || cond.includes('flurr')) return '‚ùÑÔ∏è';
            if (cond.includes('thunder') || cond.includes('storm')) return '‚õàÔ∏è';
            if (cond.includes('fog') || cond.includes('mist')) return 'üå´Ô∏è';
            if (cond.includes('wind')) return 'üí®';
            if (cond.includes('mix')) return 'üå®Ô∏è';
            
            return 'üå§Ô∏è';
        }

        // Fetch and parse RSS feed for forecast
        async function fetchForecast() {
            try {
                let response;
                try {
                    response = await fetch(CONFIG.CORS_PROXY + encodeURIComponent(CONFIG.RSS_URL));
                } catch (e) {
                    // Fallback: try direct fetch
                    response = await fetch(CONFIG.RSS_URL);
                }
                
                if (!response.ok) throw new Error('Failed to fetch RSS');
                
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                const entries = xmlDoc.querySelectorAll('entry');
                const forecasts = [];
                
                entries.forEach(entry => {
                    const title = entry.querySelector('title')?.textContent || '';
                    const summary = entry.querySelector('summary')?.textContent || '';
                    
                    // Look for forecast entries
                    if (title.match(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday|Tonight|Today)/i)) {
                        // Parse temperature from summary
                        const highMatch = summary.match(/High\s*(minus\s*)?(\d+)/i);
                        const lowMatch = summary.match(/Low\s*(minus\s*)?(\d+)/i);
                        
                        let high = null;
                        let low = null;
                        
                        if (highMatch) {
                            high = parseInt(highMatch[2]);
                            if (highMatch[1]) high = -high;
                        }
                        if (lowMatch) {
                            low = parseInt(lowMatch[2]);
                            if (lowMatch[1]) low = -low;
                        }
                        
                        // Extract condition from title
                        const conditionMatch = title.match(/:\s*(.+)/);
                        const condition = conditionMatch ? conditionMatch[1].trim() : '';
                        
                        const dayMatch = title.match(/^(\w+)/);
                        const dayName = dayMatch ? dayMatch[1] : '';
                        
                        forecasts.push({
                            day: dayName,
                            condition: condition,
                            high: high,
                            low: low,
                            isNight: title.toLowerCase().includes('night') || title.toLowerCase().includes('tonight')
                        });
                    }
                });
                
                forecastData = combineDayNightForecasts(forecasts);
                displayForecast();
                
            } catch (error) {
                console.error('Error fetching forecast:', error);
                document.getElementById('forecast-card').innerHTML = `
                    <h2>7-Day Forecast</h2>
                    <div class="error">
                        Unable to load forecast.<br>
                        <small><a href="https://weather.gc.ca/en/location/index.html?coords=49.631,-114.693" target="_blank">View at Environment Canada ‚Üí</a></small>
                    </div>
                `;
            }
        }

        // Combine day and night forecasts
        function combineDayNightForecasts(forecasts) {
            const combined = [];
            let i = 0;
            let dayOffset = 0;
            
            while (i < forecasts.length && combined.length < 7) {
                const current = forecasts[i];
                const next = forecasts[i + 1];
                
                if (current.isNight) {
                    combined.push({
                        day: current.day === 'Tonight' ? 'Tonight' : current.day,
                        condition: current.condition,
                        high: null,
                        low: current.low || current.high,
                        icon: getWeatherIcon(current.condition),
                        dayOffset: dayOffset
                    });
                    i++;
                    dayOffset++;
                } else if (next && next.isNight) {
                    combined.push({
                        day: current.day,
                        condition: current.condition,
                        high: current.high,
                        low: next.low || next.high,
                        icon: getWeatherIcon(current.condition),
                        dayOffset: dayOffset
                    });
                    i += 2;
                    dayOffset++;
                } else {
                    combined.push({
                        day: current.day,
                        condition: current.condition,
                        high: current.high,
                        low: current.low,
                        icon: getWeatherIcon(current.condition),
                        dayOffset: dayOffset
                    });
                    i++;
                    dayOffset++;
                }
            }
            
            return combined;
        }

        // Display forecast with historical records
        function displayForecast() {
            if (!forecastData || forecastData.length === 0) {
                document.getElementById('forecast-card').innerHTML = `
                    <h2>7-Day Forecast</h2>
                    <div class="error">No forecast data available</div>
                `;
                return;
            }
            
            const today = new Date();
            
            const html = `
                <h2>7-Day Forecast</h2>
                <div class="forecast-list">
                    ${forecastData.map((day, index) => {
                        // Calculate the date for this forecast day
                        const forecastDate = new Date(today);
                        forecastDate.setDate(today.getDate() + day.dayOffset);
                        const dateKey = getDateKey(forecastDate);
                        
                        // Look up historical records for this date
                        let recordsHtml = '';
                        if (recordsData?.records_by_day?.[dateKey]) {
                            const records = recordsData.records_by_day[dateKey];
                            const recHigh = records.record_high !== null ? formatTempInt(records.record_high) : '--';
                            const recLow = records.record_low !== null ? formatTempInt(records.record_low) : '--';
                            recordsHtml = `
                                <div class="forecast-records">
                                    üìä Records: <span class="rec-high">${recHigh}¬∞</span> / <span class="rec-low">${recLow}¬∞</span>
                                    <span style="opacity: 0.7">(${records.record_high_year || '?'}/${records.record_low_year || '?'})</span>
                                </div>
                            `;
                        }
                        
                        return `
                            <div class="forecast-list-item${index === 0 ? ' today' : ''}">
                                <span class="forecast-list-day">${day.day}</span>
                                <span class="forecast-list-condition">${day.icon} ${day.condition}</span>
                                <span class="forecast-list-temps">
                                    ${day.high !== null ? `<span class="forecast-high">${day.high}¬∞</span>` : ''}
                                    ${day.low !== null ? `<span class="forecast-low"> / ${day.low}¬∞</span>` : ''}
                                </span>
                                ${recordsHtml}
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 15px; text-align: center; font-size: 0.8em; color: #555;">
                    <a href="https://weather.gc.ca/en/location/index.html?coords=49.631,-114.693" target="_blank" style="color: #667eea;">
                        Full forecast at Environment Canada ‚Üí
                    </a>
                </div>
            `;
            document.getElementById('forecast-card').innerHTML = html;
        }

        // Fetch daily records data
        async function fetchDailyRecords() {
            try {
                let response;
                try {
                    response = await fetch(CONFIG.RECORDS_JSON_URL + '?t=' + Date.now());
                } catch (e) {
                    response = await fetch(CONFIG.GITHUB_RAW_URL + 'daily_records.json?t=' + Date.now());
                }
                
                if (response.ok) {
                    recordsData = await response.json();
                }
            } catch (error) {
                console.log('Daily records not yet available');
            }
        }

        // Fetch temperature history
        async function fetchTemperatureHistory() {
            try {
                let response;
                try {
                    response = await fetch(CONFIG.HISTORY_JSON_URL + '?t=' + Date.now());
                } catch (e) {
                    response = await fetch(CONFIG.GITHUB_RAW_URL + 'temperature_history.json?t=' + Date.now());
                }
                
                if (response.ok) {
                    historyData = await response.json();
                }
            } catch (error) {
                console.log('Temperature history not yet available');
            }
        }

        // Fetch current conditions
        async function fetchCurrentConditions() {
            try {
                await Promise.all([
                    (async () => {
                        let response;
                        try {
                            response = await fetch(CONFIG.WEATHER_JSON_URL + '?t=' + Date.now());
                        } catch (e) {
                            response = await fetch(CONFIG.GITHUB_RAW_URL + 'current_conditions.json?t=' + Date.now());
                        }
                        
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        
                        const rawData = await response.json();
                        dailyStats = rawData.daily_stats;
                        
                        currentData = {
                            temperature: rawData.conditions?.temperature,
                            condition: rawData.conditions?.condition,
                            pressure: rawData.conditions?.pressure_kpa,
                            tendency: rawData.conditions?.pressure_tendency,
                            windSpeed: rawData.conditions?.wind_speed_kmh,
                            windGust: rawData.conditions?.wind_gust_kmh,
                            dailyMaxGust: rawData.conditions?.daily_max_gust_kmh || rawData.daily_stats?.max_gust_kmh,
                            windDirection: rawData.conditions?.wind_direction,
                            humidity: rawData.conditions?.humidity_percent,
                            dewpoint: rawData.conditions?.dewpoint,
                            timestamp: rawData.timestamp || rawData.fetch_time_utc
                        };
                    })(),
                    fetchTemperatureHistory(),
                    fetchDailyRecords(),
                    fetchForecast()
                ]);
                
                displayCurrentConditions(currentData);
                displayClimateNormals();
                displayWindConditions(currentData);
                displayPressure(currentData);
                
            } catch (error) {
                console.error('Error fetching weather data:', error);
                document.getElementById('current-card').innerHTML = `
                    <h2>Current Conditions</h2>
                    <div class="error">
                        <strong>Unable to load current conditions.</strong><br>
                        <small><a href="https://weather.gc.ca/en/location/index.html?coords=49.631,-114.693" target="_blank">View at Environment Canada</a></small>
                    </div>
                `;
            }
        }

        // Display current conditions with history and records
        function displayCurrentConditions(data) {
            const today = new Date();
            const todayKey = getDateKey(today);
            
            let todaysRecordsHTML = '';
            if (recordsData?.records_by_day?.[todayKey]) {
                const todayRecords = recordsData.records_by_day[todayKey];
                
                let recordBrokenHTML = '';
                if (dailyStats?.max_temp !== null && todayRecords.record_high !== null) {
                    if (dailyStats.max_temp > todayRecords.record_high) {
                        recordBrokenHTML = `<span class="record-broken">üî• NEW RECORD! ${formatTemp(dailyStats.max_temp)}¬∞C</span>`;
                    }
                }
                
                todaysRecordsHTML = `
                    <div class="todays-records">
                        <div class="todays-records-title">üìä Today's Historical Records (${today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})</div>
                        <div class="records-grid">
                            <div class="record-item record-high">
                                <div class="record-label">Record High</div>
                                <div class="record-temp">${todayRecords.record_high !== null ? formatTemp(todayRecords.record_high) + '¬∞' : '--'}</div>
                                <div class="record-year">${todayRecords.record_high_year || '--'}</div>
                                ${recordBrokenHTML}
                            </div>
                            <div class="record-item record-low">
                                <div class="record-label">Record Low</div>
                                <div class="record-temp">${todayRecords.record_low !== null ? formatTemp(todayRecords.record_low) + '¬∞' : '--'}</div>
                                <div class="record-year">${todayRecords.record_low_year || '--'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            let historyHTML = '';
            if (historyData?.daily_records?.length > 0) {
                historyHTML = `
                    <div class="history-section">
                        <div class="history-title">Past 7 Days (Observed High/Low ‚Üí Records)</div>
                        ${historyData.daily_records.map(record => {
                            const date = new Date(record.date);
                            const dayName = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                            const dateKey = getDateKey(date);
                            
                            let recordsInfo = '';
                            let markers = '';
                            
                            if (recordsData?.records_by_day?.[dateKey]) {
                                const dayRecords = recordsData.records_by_day[dateKey];
                                
                                if (record.high !== null && dayRecords.record_high !== null && record.high >= dayRecords.record_high) {
                                    markers += '<span class="record-marker high">REC</span>';
                                }
                                if (record.low !== null && dayRecords.record_low !== null && record.low <= dayRecords.record_low) {
                                    markers += '<span class="record-marker low">REC</span>';
                                }
                                
                                recordsInfo = `Rec: ${dayRecords.record_high !== null ? formatTemp(dayRecords.record_high) : '--'}¬∞ / ${dayRecords.record_low !== null ? formatTemp(dayRecords.record_low) : '--'}¬∞`;
                            }
                            
                            return `
                                <div class="history-row">
                                    <span class="history-date">${dayName}</span>
                                    <span class="history-temps">${formatTemp(record.high)}¬∞ / ${formatTemp(record.low)}¬∞${markers}</span>
                                    <span class="history-records">${recordsInfo}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            document.getElementById('current-card').innerHTML = `
                <h2>Current Conditions</h2>
                <div class="current-temp">
                    ${formatTemp(data.temperature)}<span class="unit">¬∞C</span>
                </div>
                <div class="condition">${data.condition || 'Not Available'}</div>
                <div class="detail-row">
                    <span class="detail-label">Humidity</span>
                    <span class="detail-value">${data.humidity || '--'}%</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Dewpoint</span>
                    <span class="detail-value">${formatTemp(data.dewpoint)}¬∞C</span>
                </div>
                ${todaysRecordsHTML}
                ${historyHTML}
            `;
        }

        // Display wind conditions
        function displayWindConditions(data) {
            const arrows = {
                'N': '‚Üì', 'NNE': '‚Üì', 'NE': '‚Üô', 'ENE': '‚Üô',
                'E': '‚Üê', 'ESE': '‚Üê', 'SE': '‚Üñ', 'SSE': '‚Üñ',
                'S': '‚Üë', 'SSW': '‚Üë', 'SW': '‚Üó', 'WSW': '‚Üó',
                'W': '‚Üí', 'WNW': '‚Üí', 'NW': '‚Üò', 'NNW': '‚Üò'
            };
            const angles = {
                'N': 180, 'NNE': 202.5, 'NE': 225, 'ENE': 247.5,
                'E': 270, 'ESE': 292.5, 'SE': 315, 'SSE': 337.5,
                'S': 0, 'SSW': 22.5, 'SW': 45, 'WSW': 67.5,
                'W': 90, 'WNW': 112.5, 'NW': 135, 'NNW': 157.5
            };
            
            const arrow = data.windDirection ? (arrows[data.windDirection.toUpperCase()] || '‚óÜ') : '‚óÜ';
            const rotation = data.windDirection ? (angles[data.windDirection.toUpperCase()] || 0) : 0;
            
            let gustHTML = '';
            if (data.windGust && data.windGust > 0) {
                gustHTML = `
                    <div class="gust-info">
                        Current Gusts: <span class="gust-speed">${data.windGust} km/h</span>
                        (${(data.windGust * 0.621371).toFixed(1)} mph)
                    </div>
                `;
            }
            
            let dailyMaxGustHTML = '';
            if (data.dailyMaxGust && data.dailyMaxGust > 0) {
                dailyMaxGustHTML = `
                    <div class="daily-max-gust">
                        <div class="label">üå™Ô∏è Today's Max Gust</div>
                        <div class="value">${data.dailyMaxGust} km/h (${(data.dailyMaxGust * 0.621371).toFixed(1)} mph)</div>
                    </div>
                `;
            }
            
            document.getElementById('wind-card').innerHTML = `
                <h2>Wind Conditions</h2>
                <div class="wind-direction">
                    <div class="wind-arrow" style="transform: rotate(${rotation}deg);">${arrow}</div>
                    <div style="margin-top: 10px; color: #666; font-size: 1.2em;">${data.windDirection || 'Variable'}</div>
                </div>
                <div class="wind-speed">${data.windSpeed || '0'} km/h</div>
                <div style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9em;">
                    ${data.windSpeed ? `${(data.windSpeed * 0.621371).toFixed(1)} mph` : ''}
                </div>
                ${gustHTML}
                ${dailyMaxGustHTML}
            `;
        }

        // Display pressure
        function displayPressure(data) {
            let trendText = '', trendClass = '';
            if (data.tendency) {
                if (data.tendency.includes('ris')) { trendText = '‚Üó Rising'; trendClass = 'trend-up'; }
                else if (data.tendency.includes('fall')) { trendText = '‚Üò Falling'; trendClass = 'trend-down'; }
                else { trendText = '‚Üí Steady'; }
            }
            
            document.getElementById('pressure-card').innerHTML = `
                <h2>Air Pressure</h2>
                <div class="pressure-value">
                    ${data.pressure !== undefined ? data.pressure.toFixed(1) : '--'} <span style="font-size: 0.5em; color: #999;">kPa</span>
                </div>
                ${trendText ? `<div class="trend ${trendClass}">${trendText}</div>` : ''}
                <div style="text-align: center; margin-top: 15px; color: #666; font-size: 0.9em;">
                    ${data.pressure ? `${(data.pressure * 10).toFixed(1)} mb | ${(data.pressure * 0.2953).toFixed(2)} inHg` : ''}
                </div>
                <div style="margin-top: 20px; padding: 12px; background: rgba(255,255,255,0.3); border-radius: 8px; font-size: 0.85em; color: #555;">
                    <strong>Wind Prediction:</strong> Falling pressure often means wind & storms ahead. Rising pressure brings calmer conditions.
                </div>
            `;
        }

        // Display climate normals
        function displayClimateNormals() {
            const today = new Date();
            const month = today.toLocaleDateString('en-US', { month: 'long' });
            
            const monthlyNormals = {
                'January': { high: -2, low: -14 }, 'February': { high: 0, low: -12 },
                'March': { high: 4, low: -8 }, 'April': { high: 10, low: -3 },
                'May': { high: 15, low: 2 }, 'June': { high: 19, low: 6 },
                'July': { high: 23, low: 8 }, 'August': { high: 22, low: 7 },
                'September': { high: 17, low: 3 }, 'October': { high: 11, low: -2 },
                'November': { high: 2, low: -9 }, 'December': { high: -2, low: -13 }
            };
            
            const normals = monthlyNormals[month] || { high: 0, low: 0 };
            
            document.getElementById('historical-card').innerHTML = `
                <h2>Climate Normals</h2>
                <div class="detail-row">
                    <span class="detail-label">Month</span>
                    <span class="detail-value">${month}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Normal High</span>
                    <span class="detail-value">${normals.high}¬∞C</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Normal Low</span>
                    <span class="detail-value">${normals.low}¬∞C</span>
                </div>
                ${currentData?.temperature !== undefined ? `
                <div class="detail-row">
                    <span class="detail-label">Current vs Normal</span>
                    <span class="detail-value" style="color: ${currentData.temperature > normals.high ? '#e74c3c' : currentData.temperature < normals.low ? '#3498db' : '#27ae60'};">
                        ${currentData.temperature > normals.high ? '‚ñ≤ Above Normal' : currentData.temperature < normals.low ? '‚ñº Below Normal' : '‚óè Normal Range'}
                    </span>
                </div>
                ` : ''}
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 8px; font-size: 0.9em; color: #666;">
                    <strong>Note:</strong> Climate normals based on 1981-2010 Environment Canada data. Historical records drawn from 113+ years of data (1893-2026).
                </div>
            `;
        }

        // Update timestamp
        function updateTimestamp() {
            document.getElementById('timestamp').textContent = 
                `Last updated: ${new Date().toLocaleString('en-US', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', timeZoneName: 'short'
                })}`;
        }

        // Initialize
        async function init() {
            await fetchCurrentConditions();
            updateTimestamp();
            setInterval(async () => {
                await fetchCurrentConditions();
                updateTimestamp();
            }, 10 * 60 * 1000);
        }

        init();
    </script>
</body>
</html>
