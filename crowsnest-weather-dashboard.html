<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowsnest Pass Weather</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #667eea;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .current-temp {
            font-size: 4em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }

        .current-temp .unit {
            font-size: 0.4em;
            color: #999;
        }

        .condition {
            text-align: center;
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #666;
            font-weight: 500;
        }

        .detail-value {
            color: #333;
            font-weight: 600;
        }

        .history-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }

        .history-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        .history-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 0.9em;
        }

        .history-date {
            color: #999;
        }

        .history-temps {
            color: #333;
        }

        .wind-direction {
            text-align: center;
            margin: 20px 0;
        }

        .wind-arrow {
            font-size: 3em;
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .wind-speed {
            font-size: 2em;
            font-weight: bold;
            color: #764ba2;
            margin-top: 10px;
        }

        .gust-info {
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            background: rgba(118, 75, 162, 0.1);
            border-radius: 8px;
            font-size: 0.95em;
            color: #666;
        }

        .gust-speed {
            font-weight: bold;
            color: #764ba2;
        }

        .historical-compare {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .variance {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin: 15px 0;
        }

        .variance.warmer {
            color: #e74c3c;
        }

        .variance.cooler {
            color: #3498db;
        }

        .pressure-card {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }

        .pressure-value {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            color: #5e35b1;
            margin: 15px 0;
        }

        .trend {
            text-align: center;
            font-size: 1.1em;
            color: #666;
        }

        .trend-up {
            color: #e74c3c;
        }

        .trend-down {
            color: #3498db;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .timestamp {
            text-align: center;
            color: white;
            opacity: 0.8;
            margin-top: 20px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }
            
            .current-temp {
                font-size: 3em;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèîÔ∏è Crowsnest Pass Weather</h1>
            <p>Alberta's Windiest Mountain Pass - Live from Environment Canada</p>
        </header>

        <div class="dashboard">
            <!-- Current Conditions Card -->
            <div class="card" id="current-card">
                <h2>Current Conditions</h2>
                <div class="loading">Loading current data...</div>
            </div>

            <!-- Wind Card -->
            <div class="card" id="wind-card">
                <h2>Wind Conditions</h2>
                <div class="loading">Loading wind data...</div>
            </div>

            <!-- Air Pressure Card -->
            <div class="card pressure-card" id="pressure-card">
                <h2>Air Pressure</h2>
                <div class="loading">Loading pressure data...</div>
            </div>

            <!-- Historical Comparison Card -->
            <div class="card historical-compare" id="historical-card">
                <h2>Climate Normals</h2>
                <div class="loading">Loading climate data...</div>
            </div>
        </div>

        <div class="timestamp" id="timestamp"></div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            WEATHER_JSON_URL: './data/current_conditions.json',
            HISTORY_JSON_URL: './data/temperature_history.json',
            GITHUB_RAW_URL: 'https://raw.githubusercontent.com/maxmaudie-design/crowsnest-weather/main/data/',
            COORDS: { lat: 49.631, lon: -114.693 }
        };

        let currentData = null;
        let historyData = null;

        // Fetch temperature history
        async function fetchTemperatureHistory() {
            try {
                let response;
                try {
                    response = await fetch(CONFIG.HISTORY_JSON_URL + '?t=' + Date.now());
                } catch (e) {
                    response = await fetch(CONFIG.GITHUB_RAW_URL + 'temperature_history.json?t=' + Date.now());
                }
                
                if (response.ok) {
                    historyData = await response.json();
                    console.log('Temperature history loaded:', historyData);
                }
            } catch (error) {
                console.log('Temperature history not yet available:', error.message);
            }
        }

        // Fetch current conditions from GitHub-hosted JSON
        async function fetchCurrentConditions() {
            try {
                console.log('Fetching weather data from GitHub...');
                
                // Fetch both current conditions and history
                await Promise.all([
                    (async () => {
                        let response;
                        try {
                            response = await fetch(CONFIG.WEATHER_JSON_URL + '?t=' + Date.now());
                        } catch (e) {
                            console.log('Local fetch failed, trying GitHub raw URL...');
                            response = await fetch(CONFIG.GITHUB_RAW_URL + 'current_conditions.json?t=' + Date.now());
                        }
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const rawData = await response.json();
                        console.log('Weather data loaded successfully:', rawData);
                        
                        // Convert the data format to what display functions expect
                        currentData = {
                            temperature: rawData.conditions?.temperature,
                            condition: rawData.conditions?.condition || 'Not Available',
                            pressure: rawData.conditions?.pressure_kpa,
                            tendency: rawData.conditions?.pressure_tendency,
                            windSpeed: rawData.conditions?.wind_speed_kmh,
                            windGust: rawData.conditions?.wind_gust_kmh,
                            windDirection: rawData.conditions?.wind_direction,
                            humidity: rawData.conditions?.humidity_percent,
                            dewpoint: rawData.conditions?.dewpoint,
                            timestamp: rawData.timestamp || rawData.fetch_time_utc
                        };
                    })(),
                    fetchTemperatureHistory()
                ]);
                
                // Display all data
                displayCurrentConditions(currentData);
                displayWindConditions(currentData);
                displayPressure(currentData);
                displayClimateNormals();
                
            } catch (error) {
                console.error('Error fetching weather data:', error);
                document.getElementById('current-card').innerHTML = `
                    <h2>Current Conditions</h2>
                    <div class="error">
                        <strong>Unable to load current conditions.</strong><br>
                        Error: ${error.message}<br>
                        <br>
                        <small>Check: <a href="https://weather.gc.ca/en/location/index.html?coords=49.631,-114.693" target="_blank">Environment Canada</a></small>
                    </div>
                `;
                document.getElementById('wind-card').innerHTML = `
                    <h2>Wind Conditions</h2>
                    <div class="error">Data unavailable</div>
                `;
                document.getElementById('pressure-card').innerHTML = `
                    <h2>Air Pressure</h2>
                    <div class="error">Data unavailable</div>
                `;
            }
        }

        // Display current conditions with 7-day history
        function displayCurrentConditions(data) {
            let historyHTML = '';
            
            if (historyData && historyData.daily_records && historyData.daily_records.length > 0) {
                historyHTML = `
                    <div class="history-section">
                        <div class="history-title">Past 7 Days (High / Low)</div>
                        ${historyData.daily_records.map(record => {
                            const date = new Date(record.date);
                            const dayName = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                            return `
                                <div class="history-row">
                                    <span class="history-date">${dayName}</span>
                                    <span class="history-temps">${record.high.toFixed(1)}¬∞ / ${record.low.toFixed(1)}¬∞</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            const html = `
                <h2>Current Conditions</h2>
                <div class="current-temp">
                    ${data.temperature !== undefined ? data.temperature : '--'}<span class="unit">¬∞C</span>
                </div>
                <div class="condition">${data.condition || 'Not Available'}</div>
                <div class="detail-row">
                    <span class="detail-label">Humidity</span>
                    <span class="detail-value">${data.humidity || '--'}%</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Dewpoint</span>
                    <span class="detail-value">${data.dewpoint !== undefined ? data.dewpoint : '--'}¬∞C</span>
                </div>
                ${historyHTML}
            `;
            document.getElementById('current-card').innerHTML = html;
        }

        // Display wind conditions with gusts
        function displayWindConditions(data) {
            const arrow = getWindArrow(data.windDirection);
            const rotation = getWindRotation(data.windDirection);
            
            let gustHTML = '';
            if (data.windGust && data.windGust > 0) {
                gustHTML = `
                    <div class="gust-info">
                        Gusts: <span class="gust-speed">${data.windGust} km/h</span>
                        (${(data.windGust * 0.621371).toFixed(1)} mph)
                    </div>
                `;
            }
            
            const html = `
                <h2>Wind Conditions</h2>
                <div class="wind-direction">
                    <div class="wind-arrow" style="transform: rotate(${rotation}deg);">
                        ${arrow}
                    </div>
                    <div style="margin-top: 10px; color: #666; font-size: 1.2em;">
                        ${data.windDirection || 'Variable'}
                    </div>
                </div>
                <div class="wind-speed">
                    ${data.windSpeed || '0'} km/h
                </div>
                <div style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9em;">
                    ${data.windSpeed ? `${(data.windSpeed * 0.621371).toFixed(1)} mph` : ''}
                </div>
                ${gustHTML}
            `;
            document.getElementById('wind-card').innerHTML = html;
        }

        // Display pressure
        function displayPressure(data) {
            let trendText = '';
            let trendClass = '';
            
            if (data.tendency) {
                if (data.tendency.includes('ris')) {
                    trendText = '‚Üó Rising';
                    trendClass = 'trend-up';
                } else if (data.tendency.includes('fall')) {
                    trendText = '‚Üò Falling';
                    trendClass = 'trend-down';
                } else {
                    trendText = '‚Üí Steady';
                }
            }
            
            const html = `
                <h2>Air Pressure</h2>
                <div class="pressure-value">
                    ${data.pressure !== undefined ? data.pressure : '--'} <span style="font-size: 0.5em; color: #999;">kPa</span>
                </div>
                ${trendText ? `<div class="trend ${trendClass}">${trendText}</div>` : ''}
                <div style="text-align: center; margin-top: 15px; color: #666; font-size: 0.9em;">
                    ${data.pressure ? `${(data.pressure * 10).toFixed(1)} mb | ${(data.pressure * 0.2953).toFixed(2)} inHg` : ''}
                </div>
                <div style="margin-top: 20px; padding: 12px; background: rgba(255,255,255,0.3); border-radius: 8px; font-size: 0.85em; color: #555;">
                    <strong>Wind Prediction:</strong> Falling pressure often means wind & storms ahead. Rising pressure brings calmer conditions.
                </div>
            `;
            document.getElementById('pressure-card').innerHTML = html;
        }

        // Display climate normals info
        function displayClimateNormals() {
            const today = new Date();
            const month = today.toLocaleDateString('en-US', { month: 'long' });
            
            // Approximate normals for Crowsnest area (based on typical Rocky Mountain climate)
            const monthlyNormals = {
                'January': { high: -2, low: -14 },
                'February': { high: 0, low: -12 },
                'March': { high: 4, low: -8 },
                'April': { high: 10, low: -3 },
                'May': { high: 15, low: 2 },
                'June': { high: 19, low: 6 },
                'July': { high: 23, low: 8 },
                'August': { high: 22, low: 7 },
                'September': { high: 17, low: 3 },
                'October': { high: 11, low: -2 },
                'November': { high: 2, low: -9 },
                'December': { high: -2, low: -13 }
            };
            
            const normals = monthlyNormals[month] || { high: 0, low: 0 };
            
            const html = `
                <h2>Climate Normals</h2>
                <div class="detail-row">
                    <span class="detail-label">Month</span>
                    <span class="detail-value">${month}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Normal High</span>
                    <span class="detail-value">${normals.high}¬∞C</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Normal Low</span>
                    <span class="detail-value">${normals.low}¬∞C</span>
                </div>
                ${currentData && currentData.temperature !== undefined ? `
                <div class="detail-row">
                    <span class="detail-label">Current vs Normal</span>
                    <span class="detail-value" style="color: ${currentData.temperature > normals.high ? '#e74c3c' : currentData.temperature < normals.low ? '#3498db' : '#27ae60'};">
                        ${currentData.temperature > normals.high ? '‚ñ≤ Above Normal' : currentData.temperature < normals.low ? '‚ñº Below Normal' : '‚óè Normal Range'}
                    </span>
                </div>
                ` : ''}
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 8px; font-size: 0.9em; color: #666;">
                    <strong>Note:</strong> Climate normals based on 1981-2010 Environment Canada data. Your full historical dataset (1893-2026) contains 113+ years of detailed records.
                </div>
            `;
            document.getElementById('historical-card').innerHTML = html;
        }

        // Get wind arrow emoji
        function getWindArrow(direction) {
            if (!direction) return '‚óÜ';
            
            const arrows = {
                'N': '‚Üì', 'NNE': '‚Üì', 'NE': '‚Üô', 'ENE': '‚Üô',
                'E': '‚Üê', 'ESE': '‚Üê', 'SE': '‚Üñ', 'SSE': '‚Üñ',
                'S': '‚Üë', 'SSW': '‚Üë', 'SW': '‚Üó', 'WSW': '‚Üó',
                'W': '‚Üí', 'WNW': '‚Üí', 'NW': '‚Üò', 'NNW': '‚Üò'
            };
            
            return arrows[direction.toUpperCase()] || '‚óÜ';
        }

        // Get wind rotation angle
        function getWindRotation(direction) {
            if (!direction) return 0;
            
            const angles = {
                'N': 180, 'NNE': 202.5, 'NE': 225, 'ENE': 247.5,
                'E': 270, 'ESE': 292.5, 'SE': 315, 'SSE': 337.5,
                'S': 0, 'SSW': 22.5, 'SW': 45, 'WSW': 67.5,
                'W': 90, 'WNW': 112.5, 'NW': 135, 'NNW': 157.5
            };
            
            return angles[direction.toUpperCase()] || 0;
        }

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = 
                `Last updated: ${now.toLocaleString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit',
                    timeZoneName: 'short'
                })}`;
        }

        // Initialize dashboard
        async function init() {
            await fetchCurrentConditions();
            updateTimestamp();
            
            // Refresh every 10 minutes
            setInterval(async () => {
                await fetchCurrentConditions();
                updateTimestamp();
            }, 10 * 60 * 1000);
        }

        // Start the app
        init();
    </script>
</body>
</html>
